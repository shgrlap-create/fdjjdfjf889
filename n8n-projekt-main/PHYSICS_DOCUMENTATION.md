# StarMaps - Физика звёздной карты

## Обзор
Звёздная карта использует кастомную физику на основе Canvas 2D для создания интерактивной визуализации фильмов. Реализованы плавные анимации притяжения и отталкивания звёзд.

---

## 1. Распределение звёзд (Golden Spiral Algorithm)

### Принцип работы:
Звёзды распределяются по экрану с использованием **алгоритма золотой спирали** (Golden Angle = 137.5°), что обеспечивает равномерное заполнение пространства.

```javascript
const goldenAngle = Math.PI * (3 - Math.sqrt(5)); // ~2.399 радиан
```

### Типы узлов:
- **TOP звёзды** - располагаются ближе к центру с радиусом ~45% от максимального
- **Второстепенные звёзды** - распределены по внешнему кольцу с радиусом ~90% от максимального

### Force-Directed Layout:
После начального распределения применяется 40 итераций отталкивания для предотвращения наложения:
- Минимальная дистанция между узлами: 85px
- Сила отталкивания пропорциональна нарушению минимальной дистанции

---

## 2. Магнитное притяжение (Magnetic Attraction)

### Активация:
- Эффект активируется при движении курсора мыши по canvas
- Радиус воздействия: 150px от курсора
- Минимальная дистанция срабатывания: 20px (предотвращает резкие рывки)

### Формула:
```javascript
const attractionStrength = (1 - mouseDist / magnetRange) * 0.8;
const easing = Math.pow(attractionStrength, 2); // Квадратичное easing
node.vx += (mdx / mouseDist) * easing;
node.vy += (mdy / mouseDist) * easing;
```

### Особенности:
- Квадратичное сглаживание создаёт мягкое, плавное притяжение
- Чем ближе звезда к курсору, тем сильнее притяжение
- Эффект не срабатывает при перетаскивании узла

---

## 3. Отталкивание при перетаскивании (Repulsion on Drag)

### Активация:
- При захвате и перемещении любой звезды
- Радиус воздействия: 120px от перетаскиваемой звезды

### Формула:
```javascript
const repelFactor = Math.pow((minDist - rdist) / minDist, 2);
const repelStrength = repelFactor * 4;
node.vx += (rdx / rdist) * repelStrength;
node.vy += (rdy / rdist) * repelStrength;
```

### Особенности:
- Экспоненциальное отталкивание для плавного эффекта "расступания"
- Другие звёзды мягко отодвигаются от перетаскиваемой

---

## 4. Взаимное отталкивание при zoom (Mutual Repulsion)

### Проблема:
При увеличении масштаба (zoom in) звёзды визуально сближаются и могут накладываться.

### Решение:
Динамическое отталкивание между всеми узлами, масштабируемое с уровнем zoom:

```javascript
const minNodeDist = 70 / camera.zoom; // Адаптивная дистанция
if (nodeDist < minNodeDist) {
  const pushForce = (minNodeDist - nodeDist) / minNodeDist * 0.3;
  // Применить силу...
}
```

---

## 5. Пружинная система (Spring System)

### Возврат к исходной позиции:
После любого воздействия звёзды плавно возвращаются к своим оригинальным позициям.

```javascript
const springStrength = 0.025;
node.vx += dx * springStrength;
node.vy += dy * springStrength;
```

### Демпфирование:
```javascript
node.vx *= 0.92; // 8% затухание на каждый кадр
node.vy *= 0.92;
```

### Лимит скорости:
```javascript
const maxVel = 8; // Максимальная скорость пикселей/кадр
```

---

## 6. Поддержка мобильных устройств

### Touch Events:
- `touchstart` - начало перетаскивания или pan
- `touchmove` - движение пальца с магнитным эффектом
- `touchend` - завершение взаимодействия

### Pinch Zoom:
Поддержка масштабирования двумя пальцами:
```javascript
const dist = Math.sqrt(dx * dx + dy * dy);
const delta = dist / lastTouchDist;
camera.zoom *= delta;
```

---

## 7. Совместимость браузеров

Протестировано на:
- ✅ Chrome 120+
- ✅ Firefox 121+
- ✅ Safari 17+
- ✅ Edge 120+

Требования:
- Canvas 2D API
- requestAnimationFrame
- Touch Events API (для мобильных)

---

## 8. Параметры настройки

| Параметр | Значение | Описание |
|----------|----------|----------|
| `magnetRange` | 150px | Радиус магнитного притяжения |
| `springStrength` | 0.025 | Жёсткость пружины возврата |
| `damping` | 0.92 | Коэффициент затухания (1 = нет) |
| `maxVelocity` | 8 | Лимит скорости |
| `minNodeDist` | 85px | Мин. дистанция между узлами |
| `repelMinDist` | 120px | Радиус отталкивания при drag |

---

## 9. Производительность

- Анимация работает на 60 FPS
- Использует `requestAnimationFrame` для оптимальной синхронизации
- 300 частиц космической пыли для атмосферы
- Ленивая отрисовка: узлы появляются с задержкой (`appearDelay`)

---

*Документация создана: Январь 2026*
*Версия: 1.0*
